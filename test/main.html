<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">    
    <link rel="stylesheet" href="../css/flex.css">
    <link rel="stylesheet" href="../css/definition_form.css">
    <script type="text/javascript" src="../js/flex.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>.full {width:100%; height:100%;}</style>
  </head>

  <body class="full">
    <div class="full" style="display:flex;">
      <flex class="h full">
        <flexitem class="full" style="flex: 1;min-width:300px;overflow: auto;">
          <flex class="v full">
            <flexitem class="full" style="flex: 1;">
              <h1>hey der bub</h1>
            </flexitem>
            <flexresizer></flexresizer>
            <flexitem id="df" class="full" style="flex: 3;overflow: scroll;">
              <h1>hey der bub agin</h1>
            </flexitem>
          </flex>
        </flexitem>
        <flexresizer></flexresizer>
        <flexitem id="map" class="full" onresize="resizex()" style="flex: 3;">
        </flexitem>
      </flex>
    </div>
    <button style="position:absolute;top:0;right:0" class="btn btn-sm btn-dark export m-1">&darr;</button>
  </body>

<script type="module">
import * as DF from '../js/definition_form.js'
import { setup_generic_map } from "../js/generic_map.js";
import * as ARCS from "../js/arcs.js";

var img1 = new Image();
img1.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAAABGdBTUEAALGPC/xhBQAAAa1QTFRF5H444Ho14Xo15oQ45YQ45oI56os854Y443423HYtAAAA3HctzGAT9plE+qZM/eHE+bt///36/dy6+bVz+aFH/OHI/Nm1+aRP/vXr//jw5o9p/N/E/vPo9Kpw9bWD/vPq/vTs/enX/erW/MqV/ObT+8aR9ZM5+Zs7+sma4XRC+dGv98CR+LFs/dWt/vDh+9Ov+uDN+uDP/vj0/fDo9JRA8JFG9beG+ta686ds+6hQ+adV9ruN5oJN/PLt9MKj53Yx+qBC+J1C7qN599bD6IVM/O3h8Jxa97Bu//79+7Vu+Ld787mW/fTt8Jtf6oE78pA795c5/fPs64I77JRZ/NOq/Nu8/Lhv/unU/u7d3WQv4no343s3///++Zw995k843w3/vXt5XYy64s75H045oE45X846oo75oI554Q55YA46IU66IQ65oE56ok66IY654M56Yg62l0p3GAq3WMr5XMu6nwx53gv4Gcs/vv54mwt64Ay7YQz5HAu74c053Uv6Yc6+pw5+Jg48Ys084416Xow9JI27H8y9ZI3+Zo59pU374Y0+54695c48ow1////AGx8/AAAAA10Uk5T/fn5+fn9/fn5ywDLKOfV8VwAAAEpSURBVBjTVc5TcwMBFAXgWyVZ1LZt27YV2+aGm0YNNvc3d9PMdKbn8Xs45wBJEyKtwWi2s06bXi2kaBLoGpXX7wuFo4lkOsdlZQIaCJX3+elP4gU5BSKv/1F6uj69Upav72rQ+n03yKdnpixFFgy+0Nna1CCidPagJHkLGEPhVb6nuQNx7pCXjAPM4ahyoLuBa2lCnOclZQV7NKHkq+rrCm2IG5lUzARsInk+MYTY2V7bj8t3sYgOnKU/48ON2FrsRbyOBDVgS+ceLjcLo4h9mUU8DgYUoM9xL3ixNTaCC6k93A14JKDmsu+IV8VtXNo/Qpx0i0GYjb99vN7nbxnmZIdhulwVQMl+P/PrkWDA43Z9EkAL5P8EaCBpqoq1OKwmnUYhEVcSNPkD6BN5Z82OyewAAAAASUVORK5CYII=';
let DRAW_DATA = {
  poly_with_circles:{draw_type:'polygon', points:[{x:300,y:0},{x:400,y:0},{x:400,y:200}],circles:{radius:3,scale_with_zoom:true,color:'lime'},fill:'red',stroke:'rgba(0,0,0,0.5)'},
  poly_no_circles:{draw_type:'polygon', points:[{x:0,y:0},{x:200,y:0},{x:200,y:200}],fill:'red',stroke:'rgba(0,0,0,0.5)'},
  circle1:{draw_type:'circle', x:-200, y:-200, radius:10, fill:'red',stroke:'rgba(0,0,0,0.5)'},
  circle2:{draw_type:'circle', x:-230, y:-200, radius:10, fill:'green',stroke:'rgba(0,0,0,0.5)', scale_with_zoom:true},
  text1:{draw_type:'text',x:200,y:-200,fill_text:'hi',font:'30px Arial',fill:'red',align:'center'},
  text2:{draw_type:'text',x:200,y:-250,fill_text:'hi',font:'30px Arial',fill:'green',align:'center', scale_with_zoom:true},
  image1:{draw_type:'image', x:-200, y:200, w:100, h:100, rotation:1.57, image:img1},
  arc1:{draw_type:'arc', x0:400, y0:-300, q0:Math.PI*4/2, k:0.01, L:100, stroke:'blue', stroke_width:2},
  circleA:{
    draw_toggle:'circleA',
    x:{draw_type:'circle',fill:'blue',x:100,y:-600,radius:100,stroke:'black',stroke_width:1}
  },
  circleB:{
    draw_toggle:'circleB',
    _draw_toggle_off_:true,
    somestuff:[
        {draw_type:'circle',fill:'red',x:100,y:-800,radius:100,stroke:'black',stroke_width:5},
        {draw_type:'circle',fill:'purple',x:300,y:-800,radius:100,stroke:'black',stroke_width:5,scale_with_zoom:true}
    ]
  },
  special:{draw_type:'special_circle',xx:600,yy:-400},
  data_map:[]
};

let DRAW_EXT = {
  arc_path_draw: ARCS.arc_path_draw,
  special_circle:function(obj,ctx) {
    let trnsfrm = ctx.get_transform();
    ctx.lineWidth = 1/trnsfrm.a;
    ctx.strokeStyle = 'black';
    ctx.beginPath();
    ctx.arc(obj.xx, obj.yy, 10/trnsfrm.a, 0, 2 * Math.PI, false);
    ctx.stroke();
    let fontsize = Math.max(1,Math.floor(12/trnsfrm.a));
    ctx.font = fontsize + 'px Courier';
    ctx.textAlign = 'left';
    ctx.fillStyle = 'black';
    ctx.scale(1,-1);
    ctx.fillText('Special!',obj.xx,-obj.yy)
    ctx.scale(1,-1);
  }
};

let MAPDIV = document.querySelector('#map');
let MAPFUNCS = setup_generic_map(MAPDIV, DRAW_DATA, DRAW_EXT);
window.resizex = function(event) { if (MAPFUNCS) MAPFUNCS.resize(); }

// TEST DOWNLOAD **
document.querySelector('button.export').addEventListener('click',(e) => {
  const blob = new Blob([MAPFUNCS.export()], { type: 'text/html' });
  const a = document.createElement('a');
  let url = URL.createObjectURL(blob);
  a.href = url;
  a.download = 'export.html'; // Set a default filename
  document.body.appendChild(a); // Temporarily append to body
  a.click(); // Programmatically click the link
  document.body.removeChild(a); // Remove the temporary link  
  URL.revokeObjectURL(url); // Release the object URL
});
// ****************


// TEST ARCS **********************************************************************
let ARCPATH = new ARCS.ArcPath(false);
ARCPATH.set([{x:400,y:-300,q:0},{x:300,y:-200,q:0}])
DRAW_DATA.arcpath = ARCPATH.drawing();

MAPFUNCS.CANVAS.addEventListener('mousedown',(e) => { 
  if (ARCPATH && ARCS.mouse_down(MAPFUNCS, ARCPATH, e)) {
    DRAW_DATA.disable_map_events = true;
    DRAW_DATA.arcpath = ARCPATH.drawing();
    MAPFUNCS.draw();
  }
});

MAPFUNCS.CANVAS.addEventListener('mousemove',(e) => { 
  if (ARCPATH && ARCS.mouse_move(MAPFUNCS, ARCPATH, e)) {
    DRAW_DATA.arcpath = ARCPATH.drawing();
    MAPFUNCS.draw();
  }
});

MAPFUNCS.CANVAS.addEventListener('mouseup',(e) => { 
  DRAW_DATA.disable_map_events = false;
  ARCPATH && ARCS.mouse_up(MAPFUNCS, ARCPATH, e)
  DRAW_DATA.arcpath = ARCPATH.drawing();
  MAPFUNCS.draw();
});
// *******************************************************************************


// TEST DEFINITIONS **************************************************************
let container = document.querySelector('flexitem#df');

let on_change = function(path, value, obj) {
  if (obj.map && obj.map.shapes) {
    DRAW_DATA.data_map = obj.map.shapes.map(shape => { 
      let color = (shape.type == 'obstacle') ? 'rgba(255,0,0,0.3)' : 'rgba(0,0,255,0.3)';
      console.log('color',color,shape)
      return {draw_type:'polygon', points:shape.vertices, fill:color}
    });
  }
  if (MAPFUNCS) MAPFUNCS.draw();
  console.log('on_change','path',path,'value',value,'obj',obj);
  
}
let on_save = function(typ, path, obj) {
  let filename = prompt('Enter object filename:','item.object.json');
  if (filename) DF.download(filename,{data:obj,defintion:typ})
}
let on_load = function(typ, path, obj) {
  console.log('on_load','typ',typ,'path',path,'obj',obj);
  return obj;
}

let definitions = {
  "definition:Top": [
    {name: "number", type: "float64", description:"Number"},
    {name: "type", type: "string", description:"Type of map", options:["TypeA","TypeB"]},
    {length:"?", name: "labels", description:"Just a bunch of labels", type: "string"},
    {name: "ignored_map_with_a_really_long_name", description:"A list of shapes with attributes", type: "definition:Mapx"},
    {name: "map", description:"A list of shapes with attributes", type: "definition:Mapx"}
  ],
  "definition:KeyValue": [
    {name: "key", type: "string"},
    {name: "value", type: "string"}
  ],
  "definition:Mapx": [
    {name: "id", description:"A unique map identifier", type: "string"},
    {length: "?", name: "attributes", description:"A list of map attributes", type: "definition:KeyValue"},
    {length: "?", name: "shapes", description:"A list of 2D polygon shapes", type: "definition:Shape"}
  ],
  "definition:Point2D": [
    {name: "x",type: "float64"},
    {name: "y",type: "float64"}
  ],
  "definition:Shape": [
    {name: "id", description:"A unique shape identifier", type: "string"},
    {name: "type", description:"Shape type", type: "string", options:["drivable","obstacle"]},
    {length: "?",name: "attributes", description:"A list of shape attributes", type: "definition:KeyValue"},
    {length: "?",name: "vertices", description:"A list of vertices", type: "definition:Point2D"}
  ],
}

let DEFFORM = DF.create(container,definitions,'definition:Top',{},{
  hide_fields:[
    // /_\.map\.shapes\.[0-9]+\.vertices/ig
  ],
  on_change:on_change,
  on_save_item:on_save,
  on_load:on_load
});

DEFFORM.reload({
  number:3.14,
  type:"TypeB",
  hi:'x',
  labels:["A","B"],
  map:{
    hi:'y',
    id:"1",
    attributes:[],
    shapes:[
      {id:"A",type:'drivable',attributes:[],vertices:[{x:0,y:-10},{x:100,y:-10},{x:100,y:-100},{x:0,y:-100}]},
      {id:"B",type:'obstacle',attributes:[],vertices:[{x:1,y:-11},{x:90,y:-11},{x:90,y:-90},{x:1,y:-90}]}
    ]
  }
});
// *******************************************************************************

</script>

</html>

